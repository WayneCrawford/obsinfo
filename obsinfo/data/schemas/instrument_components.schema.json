{
    "$schema": "http://json-schema.org/draft-04/schema#",
    "title": "Instrument Components",
    "description": "OBS facility instrument components",
    "type": "object",
    "required": ["format_version", "instrument_components"],
    "properties": {
        "format_version" :       {"$ref": "#/definitions/format_version"},
        "revision" :             {"$ref": "definitions.schema.json#/revision"},
        "instrument_components": {"$ref": "#/definitions/instrument_components" },
        "yaml_anchors" :         {"$ref": "definitions.schema.json#/yaml_anchors"},
        "notes" :                {"$ref": "definitions.schema.json#/note_list"},
        "extras" :               {"$ref": "definitions.schema.json#/extras"}
    },
    "additionalProperties" : false,
    "definitions": {
        "format_version" : {
            "anyOf": [
                {"$ref" : "definitions.schema.json#/format_version"},
                {"type": "string","pattern": "^0\\.107$",
                 "comment":"version of last change to this schema"}
            ]
        },
        "instrument_components": { 
            "type": "object",
            "required": [
                "instrument_blocks"
            ],
            "properties": {
                "notes":             {"$ref": "definitions.schema.json#/note_list"},
                "instrument_blocks": {"$ref": "#/definitions/instrument_blocks"},
                "extras":            {"$ref": "definitions.schema.json#/extras"}
            },
            "additionalProperties": false
        },
        "instrument_blocks": {
            "type": "object",
            "description": "StationaXML instrument blocks",
            "required": ["datalogger", "sensor"],
            "properties": {
                "datalogger":   {"$ref": "#/definitions/dataloggers_map"},
                "preamplifier": {"$ref": "#/definitions/preamplifiers_map"},
                "sensor":       {"$ref": "#/definitions/sensors_map"}
            },
            "additionalProperties": false
        },
        "sensors_map": { 
            "description": "Map of sensor names",
            "patternProperties": {"^[A-Za-z0-9_-]+$": {"$ref": "#/definitions/sensor"}}
        },
        "sensor_configs_map": { 
            "description": "Map of configuration names for a given sensor",
            "patternProperties": {"^[A-Za-z0-9_-]+$": {"$ref": "#/definitions/sensor_config"}}
        },
        "sensor_serial_numbers_map": { 
            "description": "Map of serial numbers for a given sensor",
            "patternProperties": {"^[A-Za-z0-9_-]+$": {"$ref": "#/definitions/sensor_serial_number"}}
        },
        "dataloggers_map": {
            "description": "Map of datalogger names",
            "patternProperties" : {"^[A-Za-z0-9_-]+$": {"$ref": "#/definitions/datalogger"}}
        },
        "datalogger_configs_map": {
            "description": "Map of configuration names for a given datalogger",
            "patternProperties": {"^[A-Za-z0-9_-]+$": {"$ref": "#/definitions/datalogger_config" }}
        },
        "datalogger_serial_numbers_map": {
            "description": "Map of serial numbers for a given datalogger",
            "patternProperties": {"^[A-Za-z0-9_-]+$": {"$ref": "#/definitions/datalogger_config" }}
        },
        "preamplifiers_map": {
            "description": "Map of preamplifier ref codes",
            "patternProperties": {"^[A-Za-z0-9_-]+$": {"$ref": "#/definitions/preamplifier" }}
        },
        "preamplifier_configs_map": {
            "description": "Map of configuration names for a given  preamplifier",
            "patternProperties": {
                "^[A-Za-z0-9_-]+$": {"$ref": "#/definitions/preamplifier_config"}
            }
        },
        "preamplifier_serial_numbers_map": {
            "description": "Map of serial numbers for a given preamplifier",
            "patternProperties": {
                "^[A-Za-z0-9_-]+$": {"$ref": "#/definitions/preamplifier_serial_number"}
            }
        },
        "sensor": { 
            "description": "Basic sensor specification",
            "required": ["equipment", "response_stages", "seed_codes"],
            "properties": {
                "config_description": {"type": "string"},
                "notes":              {"$ref": "definitions.schema.json#/note_list"},
                "equipment":          {"$ref": "#/definitions/equipmentType"},
                "response_stages":    {"$ref": "#/definitions/response_stage_list"},
                "configurations":     {"$ref": "#/definitions/sensor_configs_map"},
                "serial_numbers":     {"$ref": "#/definitions/sensor_serial_numbers_map"},
                "seed_codes":         {"$ref": "#/definitions/seed_codes"}
            },
            "additionalProperties": false
        },
        "sensor_config": { 
            "description": "Configuration-specific sensor properties",
            "required": ["config_description"],
            "properties": {
                "config_description": {"type": "string"},
                "equipment":          {"$ref": "#/definitions/equipmentType_noRequired"},
                "response_stages":    {"$ref": "#/definitions/response_stage_list"},
                "serial_numbers":     {"$ref": "#/definitions/sensor_serial_numbers_map"},
                "seed_codes":         {"$ref": "#/definitions/seed_codes"}
            },
            "additionalProperties": false
        },
        "sensor_serial_number"  : { 
            "description" : "Serial number-specific sensor properties",
            "properties": {
                "equipment":       {"$ref": "#/definitions/equipmentType_noRequired"},
                "response_stages": {"$ref": "#/definitions/response_stage_list"},
                "seed_codes":      {"$ref": "#/definitions/seed_codes"}
            },
            "additionalProperties": false
        },
        "datalogger" : {
            "description": "Basic datalogger specification",
            "required": ["sample_rate","response_stages","equipment"],
            "properties": {
                "notes":              {"$ref": "definitions.schema.json#/note_list"},
                "equipment":          {"$ref": "#/definitions/equipmentType"},
                "response_stages":    {"$ref": "#/definitions/response_stage_list"},
                "sample_rate":        {"type": "number", "minimum": 0},
                "delay_correction":   {"$ref": "#/definitions/delay_correction"},
                "serial_numbers":     {"$ref": "#/definitions/datalogger_serial_numbers_map"},
                "config_description": {"type": "string"},
                "configurations":     {"$ref": "#/definitions/datalogger_configs_map"}
            },
            "additionalProperties": false
        },
        "datalogger_config" : { 
            "description": "Configuration-specific datalogger properties",
            "required": ["config_description"],
            "properties": {
                "config_description": {"type": "string"},
                "equipment":          {"$ref": "#/definitions/equipmentType"},
                "response_stages":    {"$ref": "#/definitions/response_stage_list"},
                "sample_rate":        {"type": "number", "minimum": 0},
                "delay_correction":   {"$ref": "#/definitions/delay_correction"},
                "serial_numbers":     {"$ref": "#/definitions/datalogger_serial_numbers_map"}
            },
            "additionalProperties": false
        },
        "datalogger_serial_number": { 
            "description": "Serial_number-specific datalogger properties",
            "properties": {
                "equipment":        {"$ref": "#/definitions/equipmentType"},
                "response_stages":  {"$ref": "#/definitions/response_stage_list"},
                "sample_rate":      {"type": "number", "minimum": 0},
                "delay_correction": {"$ref": "#/definitions/delay_correction"}
            },
            "additionalProperties": false
        },
        "preamplifier" : {
            "description": "Basic preamplifier specification",
            "required": ["equipment"],
            "properties": {
                "config_description": {"type": "string"},
                "notes":           {"$ref": "definitions.schema.json#/note_list"},
                "equipment":       {"$ref": "#/definitions/equipmentType" },
                "response_stages": {"$ref": "#/definitions/response_stage_list" },
                "configurations":  {"$ref": "#/definitions/preamplifier_configs_map"},
                "serial_numbers":  {"$ref": "#/definitions/preamplifier_serial_numbers_map"}
            },
            "additionalProperties": false
        },
        "preamplifier_config" : {
            "description" : "Configuration-specific preamplifier properties",
            "required": ["config_description"],
            "properties": {
                "config_description": {"type": "string"},
                "equipment":          {"$ref": "#/definitions/equipmentType_noRequired"},
                "response_stages":    {"$ref": "#/definitions/response_stage_list"},
                "serial_numbers":     {"$ref": "#/definitions/preamplifier_serial_numbers_map"}
            },
            "additionalProperties": false
        },
        "preamplifier_serial_number" : {
            "description" : "Serial number-specific preamplifier properties",
            "properties": {
                "equipment":       {"$ref": "#/definitions/equipmentType_noRequired"},
                "response_stages": {"$ref": "#/definitions/response_stage_list"}
            },
            "additionalProperties": false
        },
        "equipmentType": {
            "type": "object",
            "required": ["type", "description", "manufacturer", "vendor",
                           "model", "serial_number", "calibration_date"],
            "properties": {
                "type":             {"type": ["string","null"]},
                "description":      {"type": ["string","null"]},
                "manufacturer":     {"type": ["string","null"]},
                "vendor":           {"type": ["string","null"]},
                "model":            {"type": ["string","null"]},
                "serial_number":    {"type": ["string","null"]},
                "calibration_date": {"$ref" : "definitions.schema.json#/date-time-Z"}
            },
            "additionalProperties": false
        },
        "equipmentType_noRequired": {
            "type": "object",
            "properties": {
                "type":             { "type": ["string","null"] },
                "description":      { "type": ["string","null"] },
                "manufacturer":     { "type": ["string","null"] },
                "vendor":           { "type": ["string","null"] },
                "model":            { "type": "string" },
                "serial_number":    { "type": ["string","null"] },
                "calibration_date": { "$ref" : "definitions.schema.json#/date-time-Z"}
            },
            "additionalProperties": false
        },
        "response_stage_list" : {
            "type" : "array",
            "description": "list of response-stage files#keys in JSON Pointers format",
            "items" : { "$ref": "definitions.schema.json#/URI_ref"}
        },
        "seed_codes" : {
            "description": "Seed codes, azimuths and dips associated with a sensor",
            "type" : "object",
            "required" : [
                "band_base",
                "instrument",
                "orientation"
            ],
            "properties" :  {
                "band_base":   {"$ref": "#/definitions/seed_band_base" },
                "instrument":  {"$ref": "#/definitions/seed_instrument_code" },
                "orientation": {"$ref": "#/definitions/seed_orientations_map" }
            },
            "additionalProperties": false
        },
        "seed_band_base" : {
            "type": "string",
            "description": "B for corner period >= 10s, S for <10s (output band code will be adjusted to the sample rate)",
            "enum": ["B","S","H","L","D","E","C"]
        },
        "seed_instrument_code": {
            "description": "SEED instrument code",
            "type": "string",
            "pattern": "^[A-Z]$"
        },
        "seed_orientations_map": {
            "description": "permitted orientation codes and their azimuth and dip",
            "type": "object",
            "patternProperties": {
                "^[A-Z0-9]$": {
                    "type": "object",
                    "required": ["azimuth.deg", "dip.deg"],
                    "properties": {
                        "azimuth.deg": {"$ref": "#/definitions/azimuthType"},
                        "dip.deg":     {"$ref": "#/definitions/dipType"}
                    }
                }
            }
        },
        "azimuthType" : { 
            "type" : "array",
            "minItems": 1,
            "maxItems": 2,
            "items": [
                {
                    "description": "azimuth value (degrees)",
                    "type": "number",
                    "minimum": 0,
                    "maximum": 360
                },
                {
                    "description": "azimuth error (degrees)",
                    "type": "number",
                    "minimum": 0,
                    "maximum": 180
                }
            ]
        },
        "dipType" : { 
            "type" : "array",
            "minItems": 1,
            "maxItems": 2,
            "items": [
                {
                    "description": "dip value (degrees)",
                    "type" : "number",
                    "minimum" : -90,
                    "maximum" : 90
                },
                {
                    "description": "dip error (degrees)",
                    "type" : "number",
                    "minimum" : 0,
                    "maximum" : 90
                }
            ]
        },
        "delay_correction": {
            "anyOf" : [
                {"type" : "number",
                 "description": "sets correction to this value for the last stage and 0 for all others"},
                {"type" : "boolean",
                 "description": "True: set correction=delay for each stage.  False: set correction=0 for each stage"}
            ]
        }
      }
}

{
	"$schema": "http://json-schema.org/draft-06/schema#",
	"title": "Instrumentation",
	"description": "OBS facility instruments and their components",
	"type": "object",
	"required": [
		"format_version",
		"instrumentation"
	],
	"properties": {
		"format_version": {
			"description": "Version of this file's schema",
			"type": "string",
			"minLength": 3,
			"pattern": "^0\\.92$"
		},
		"instrumentation": {
			"type": "object",
			"required": [
				"revision",
				"facility",
				"response_format",
				"response_directory",
				"variables",
				"models",
				"individuals"
			],
			"properties": {
				"revision": {
					"type": "object",
					"description": "Date provenance of instrumentation information",
					"required": ["date"],
					"properties": {
					    "date": { "$ref": "#/definitions/date" },
					    "author": {"type":"string"}
					}
				},
				"response_format": {
					"type": "string",
					"enum": ["DBIRD", "RESPONSE_YAML"],
					"description": "format of response files"
				},
				"response_directory": {
					"type": "string",
					"description": "directory in which the response files are found"
				},
				"facility": {
					"type": "object",
					"description": "OBS facility information",
					"required": ["reference_name", "full_name", "email", "website"],
					"properties": {
						"reference_name": {
							"type": "string",
							"description": "YAML filename should be '{reference_name}.instrumentation.yaml'"
						},
						"full_name": {
							"type": "string"
						},
						"email": {
							"type": "string",
							"format": "email"
						},
						"website": {
							"type": "string",
							"format": "uri"
						},
						"director": {
							"type": "string"
						},
						"chief_engineer": {
							"type": "string"
						},
						"phone_number": {
							"type": "string"
						}
					}
				},
				"variables": {
					"type": "array",
					"minItems": 0,
					"items": {
						"type": "string",
						"minLength": 1
					},
					"uniqueItems": true,
					"description": "Variables that must be specified in the Network file"
				},
				"models": {
					"type": "object",
					"description": "Generic instrument and component models",
					"required": ["component", "instrument"],
					"properties": {
						"component": {
							"type": "object",
							"description": "Instrument component models",
							"required": [
								"datalogger",
								"ana_filter",
								"sensor",
								"azi_dip"
							],
							"properties": {
								"datalogger": {
									"title": "Datalogger specification",
									"type": "object",
									"minProperties": 1,
									"description": "...",
									"patternProperties": {
										"^[A-Za-z0-9_-]+$": {
											"allOf": [
												{ "$ref": "#/definitions/equipmentType" },
												{ "$ref": "#/definitions/responseFile" }
											]
										}
									}
								},
								"ana_filter": {
									"type": "object",
									"title": "Analog filter/gain specification",
									"minProperties": 1,
									"description": "...",
									"patternProperties": {
										"^[A-Za-z0-9_-]+$": {
											"allOf": [
												{ "$ref": "#/definitions/equipmentType" },
												{ "$ref": "#/definitions/responseFile" }
											]
										}
									}
								},
								"sensor": {
									"title": "Sensor specification",
									"type": "object",
									"minProperties": 1,
									"description": "...",
									"patternProperties": {
										"^[A-Za-z0-9_-]+$": {
											"allOf": [
												{"$ref": "#/definitions/equipmentType"},
												{"$ref": "#/definitions/responseFile"}
											]
										}
									}
								},
								"digital_filter": {
									"title": "Digital filter specification (not used for StationXML, where digitizer and digital filter are combined into datalogger)",
									"type": "object",
									"minProperties": 1,
									"description": "...",
									"patternProperties": {
										"^[A-Za-z0-9_-]+$": {
											"allOf": [
												{"$ref": "#/definitions/equipmentType"},
												{"$ref": "#/definitions/responseFile"}
											]
										}
									}
								},
								"digitizer": {
									"title": "Digitizer specification (not used for StationXML, where digitizer and digital filter are combined into datalogger)",
									"type": "object",
									"minProperties": 1,
									"description": "...",
									"patternProperties": {
										"^[A-Za-z0-9_-]+$": {
											"allOf": [
												{"$ref": "#/definitions/equipmentType"},
												{"$ref": "#/definitions/responseFile"}
											]
										}
									}
								},
								"azi_dip": {
									"type": "object",
									"properties": {
										"azimuth": {"type": "string"},
										"dip": {"type": "string"}
									}
								}
							},
							"additionalProperties": false
						},
						"instrument": {
							"type": "object",
							"minProperties": 1,
							"patternProperties": {
								"^[A-Za-z0-9_-]+$": {
									"type": "object",
									"description": "Individual instrument model description",
									"required": [
										"equipment",
										"channels"
									],
									"properties": {
										"equipment": {"$ref": "#/definitions/equipmentType"},
										"channels": {
											"type": "object",
											"description": "Components by channel",
											"patternProperties": {
												"^[A-Za-z]{3}:[0-9]{2}$": {
													"type": "object",
													"description": "Each string must correspond to a component model specified above",
													"required": [
														"datalogger",
														"ana_filter",
														"sensor",
														"azi_dip"
													],
													"properties": {
														"datalogger": {
															"type": "string"
														},
														"ana_filter": {
															"type": "string"
														},
														"sensor": {
															"type": "string"
														},
														"azi_dip": {
															"type": "string"
														}

													}
												}
											}
										}
									}
								}
							}
						}
					}
				},
				"individuals": {
					"type": "object",
					"description": "Specific instrument and sensor models, based on serial number",
					"required": ["sensor", "instrument"],
					"properties": {
						"sensor": {
							"type": "object",
							"minProperties": 1,
							"description": "model name: must correspond to a key in models:component:sensor",
							"patternProperties": {
								"^[A-Za-z0-9_-]+$": {
									"type": "object",
									"description": "Sensor particularities by serial number",
									"minProperties": 0,
									"patternProperties": {
										"^[A-Za-z0-9_-]+$": {
											"description": "Properties to change",
                                            "allOf": [
                                                {"$ref": "#/definitions/equipmentType_noRequired"},
                                                {"$ref": "#/definitions/responseFile_noRequired"}
                                            ]
										}
									}
								}
							},
							"additionalProperties": false
						},
						"instrument": {
							"type": "object",
							"minProperties": 1,
							"description": "model name: must correspond to a key in models:instrument",
							"patternProperties": {
								"^[A-Za-z0-9_-]+$": {
									"type": "object",
									"description": "Instrument particularities by serial number",
									"minProperties": 0,
									"patternProperties": {
										"^[0-9X]{2}$": {
											"type": "object",
											"description": "components to change",
											"minProperties": 0,
											"patternProperties": {
												"^[A-Za-z0-9]{3}:[0-9]{2}$": {
													"type": "object",
													"description": "components to change",
													"properties": {
														"ana_filter": {
															"$ref": "#/definitions/componentRef"
														},
														"datalogger": {
															"$ref": "#/definitions/componentRef"
														},
														"sensor": {
															"$ref": "#/definitions/componentRef"
														},
														"azi_dip": {
															"type": "object",
															"properties": {
																"azimuth": {
																	"type": "string"
																},
																"dip": {
																	"type": "string"
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					},
					"additionalProperties": false
				}
			}
		},
		"loggers_NRL": {
			"type": "object",
			"description": "Convenience definitions for creating Nominal Reference Library (not yet implemented)",
			"patternProperties": {
				"^[A-Za-z0-9_-]+$": {
					"type": "object",
					"description": "keys are NRL 'datalogger' names.  'datalogger' and 'ana_filter' names must have been used as keys in models:components",
					"required": ["datalogger", "ana_filter"],
					"properties": {
						"datalogger": {
							"type": "string"
						},
						"ana_filter": {
							"type": "string"
						}
					}
				}
			}
		}
	},
	"definitions": {
		"equipmentType": {
			"type": "object",
			"required": ["type", "description", "manufacturer", "vendor",
				"model", "serial_number", "calibration_date"
			],
			"properties": {
                "type": { "type": ["string","null"] },
                "description": { "type": ["string","null"] },
                "manufacturer": { "type": ["string","null"] },
                "vendor": { "type": ["string","null"] },
                "model": { "type": ["string","null"] },
                "serial_number": { "type": ["string","null"] },
                "calibration_date": {
                    "type": ["string","null"],
                    "description": "Date of calibration used in response file",
                    "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$",
                    "format": "date-time"
                }
			}
		},
		"equipmentType_noRequired": {
			"type": "object",
			"properties": {
                "type": { "type": ["string","null"] },
                "description": { "type": ["string","null"] },
                "manufacturer": { "type": ["string","null"] },
                "vendor": { "type": ["string","null"] },
                "model": { "type": "string" },
                "serial_number": { "type": ["string","null"] },
                "calibration_date": {
                    "type": ["string","null"],
                    "description": "Date of calibration used in response file",
                    "pattern": "^([0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z)|([0-9]{4})$"
                }
			}
		},
		"responseFile": {
			"type": "object",
			"required": ["response_file"],
			"properties": {
				"response_file": {
					"type": "string",
					"description": "appended to response_directory"
				}
			}
        },
     	"responseFile_noRequired": {
			"type": "object",
			"properties": {
				"response_file": {
					"type": "string",
					"description": "appended to response_directory"
				}
			}
        },
        "componentRef": {
            "type": "object",
            "description": "Reference to a specific component",
            "required": ["model", "serial_number"],
            "properties": {
                "model": {
                    "anyOf": [
                        {
                            "type": "string",
                            "description": "component model (if None, use existing model (can only change serial number))"
                        },
                        { "type" : "null" }
                    ]
                },
                "serial_number": {
                    "anyOf": [
                        {
                            "type": "string",
                            "description": "serial number.  If model specified, will search for specific instance of this model-serial number.  If not, will just fill in 'serial_number' field"
                        },
                        { "type" : "null" }
                    ]
                }
            }
        },
		"phone": {
            "type": "string",
            "description": "...",
			"pattern": "^[0-9]+-[0-9]+$"
		},
        "date": {
            "type": "string",
            "description": "Date in yyyy-mm-dd format",
			"pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
        }
	}
}

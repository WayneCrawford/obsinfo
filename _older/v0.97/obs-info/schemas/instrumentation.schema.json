{
	"$schema": "http://json-schema.org/draft-06/schema#",
	"title": "Instrumentation",
	"description": "OBS facility instruments and their components",
	"type": "object",
	"required": [ "instrumentation" ],
	"properties": {
		"instrumentation": {
			"type": "object",
			"required": [
                "format_version",
				"revision",
				"facility",
				"components_file",
				"instruments"
			],
			"properties": {
                "format_version": { "$ref": "#/definitions/format_version" },
				"revision": {"$ref": "#/definitions/revision" },
				"facility": { "$ref": "#/definitions/facility" },
				"components_file": { "$ref": "#/definitions/components_file" },
				"instruments": { "$ref": "#/definitions/instruments" }
			}
		},
		"loggers_NRL": { "$ref": "#/definitions/loggers_NRL" }
	},
	"definitions": {
        "format_version": { 
            "description": "Version of this file's schema",
            "type": "string",
            "minLength": 3,
            "pattern": "^0\\.97$"
        },
        "revision": {
            "description": "Date provenance of instrumentation information",
            "type": "object",
            "required": ["date","authors"],
            "properties": {
                "date": { "$ref": "#/definitions/date" },
                "authors": {
                    "type": "array",
                    "minItems" : 1,
                    "items" : {"$ref": "#/definitions/author"}
                }
            }
        },
        "facility": { 
            "type": "object",
            "description": "OBS facility information",
            "required": [
                "reference_name", 
                "full_name", 
                "email"
            ],
            "properties": {
                "reference_name": {
                    "type": "string",
                    "description": "YAML filename should be '{reference_name}.instrumentation.yaml'"
                },
                "full_name": { "type": "string"},
                "email": { "type": "string", "format": "email"},
                "website": { "type": "string", "format": "uri" },
                "phone_number": { "type": "string" }
            }
        },
        "components_file": { 
            "type": "string",
            "description": "file containing instrumentation components"
        },
        "instruments": {
            "type": "object",
            "description": "Instruments, keyed by reference code",
            "required": ["generic"],
            "properties": {
                "generic" : { "$ref": "#/definitions/instruments_generic"},
                "specific" : {  "$ref": "#/definitions/instruments_specific"}
            },
            "additionalProperties": false
        },
        "instruments_generic" : {
            "description" : "Generic descriptions of instruments, keyed by instrument model_configuration",
            "type": "object",
            "minProperties": 1,
            "patternProperties": {
                "^[A-Za-z0-9_-]+$": { 
                    "type": "object",
                    "description": "Individual instrument",
                    "required": [
                        "equipment",
                        "das_components"
                    ],
                    "properties": {
                        "equipment": { "$ref": "#/definitions/equipmentType"},
                        "das_components": {  "$ref": "#/definitions/measurement_instruments_generic"}
                    }
                }
            }
        },
        "das_components_generic": { 
            "type": "object",
            "description": "individual measurement instruments specified by das component (channel on a given das) and possibly separate connector named as component_connector)",
            "patternProperties": {
                "^[A-Za-z0-9]+$": {
                    "type": "object",
                    "description": "Each string must correspond to a component reference_code in the instrumentation_components file",
                    "required": [
                        "orientation_code",
                        "datalogger",
                        "sensor"
                    ],
                    "properties" : {
                        "orientation_code" : { "$ref": "#/definitions/orientation_code"},
                        "datalogger" :       { "$ref": "#/definitions/instrument_component_generic"},
                        "preamplifier" :     { "$ref": "#/definitions/instrument_component_generic"},
                        "sensor" :           { "$ref": "#/definitions/instrument_component_generic"}
                    }
                }
            }
        },
        "orientation_code" : {
            "type" : "string",
            "pattern" : "^[A-Z0-9]$"
        },
        "instrument_component_generic" : {  
            "type": "object",
            "required": ["reference_code"],
            "properties" : {  "reference_code" : {"type" : "string"} }
        },
        "instruments_specific" : { 
            "description" : "Specific descriptions of instruments, keyed by instrument model_configuration",
            "type" : "object",
            "minProperties" : 1,
            "patternProperties" : {
                "^[A-Za-z0-9_-]+$": {
                    "description" : "keys by serial number",
                    "type" : "object",
                    "minProperties" : 1,
                    "patternProperties" : {
                        "^[A-Za-z0-9_-]+$": { "$ref" : "#/definitions/instrument_specific" }
                    }
                }
            }
        },
        "instrument_specific" : {
            "anyOf" : [
                {   "$ref" : "#/definitions/instrument_specific_equipment" },
                {   "$ref" : "#/definitions/instrument_specific_by_das_components" }
            ]
        },
        "instrument_specific_equipment" : {
            "type" : "object",
            "required" : ["equipment"],
            "properties" : {
                "equipment" : { "$ref" : "#/definitions/equipmentType_noRequired" }
            }
        },
        "instrument_specific_by_das_components" : {
            "type" : "object",
            "required" : ["das_components"],
            "properties" : {
                "das_components" : { "$ref" : "#/definitions/measurement_instruments_specific" }
            }
        },
        "measurement_instruments_generic": { 
            "type": "object",
            "description": "instrument measurement channels specified by das connector_component",
            "patternProperties": {
                "^[A-Za-z0-9]+$": {
                    "type": "object",
                    "description": "Each string must correspond to a component reference_code in the instrumentation_components file",
                    "required": [
                        "orientation_code",
                        "datalogger",
                        "sensor"
                    ],
                    "properties" : {
                        "orientation_code" : { "$ref" : "#/definitions/orientation_code"},
                        "datalogger" : { "$ref" : "#/definitions/instrument_component_generic"},
                        "preamplifier" : { "$ref" : "#/definitions/instrument_component_generic"},
                        "sensor":     { "$ref" : "#/definitions/instrument_component_generic"}
                    }
                }
            }
        },
        "measurement_instruments_specific": { 
            "type": "object",
            "description": "specific instrument measurement channels",
            "patternProperties": {
                "^[A-Za-z0-9]+$": {
                    "type": "object",
                    "description": "Each string is an orientation_code or das_connector_component",
                    "properties": {
                        "orientation_code": { "$ref" : "#/definitions/orientation_code"},
                        "datalogger": { "$ref" : "#/definitions/instrument_component_specific"},
                        "preamplifier": { "$ref" : "#/definitions/instrument_component_specific"},
                        "sensor":     { "$ref" : "#/definitions/instrument_component_specific"}
                    }
                }
            }
        },
        "instrument_component_specific": { 
            "anyOf": [
                {"$ref": "#/definitions/equipmentType_noRequired"},
                { "properties" : { "reference_code" : {"type" : "string"}}}
            ]
        },
		"loggers_NRL": {
			"type": "object",
			"description": "Convenience definitions for creating Nominal Reference Library (not yet implemented)",
			"required": ["loggers"],
			"properties": {
			    "datalogger_configs": {
			        "type":"array",
			        "items": {"type":"string"}
			    },
			    "loggers": {
			        "type": "object",
                    "patternProperties": {
                        "^[A-Za-z0-9_-]+$": { 
                            "type": "object",
                            "description": "keys are NRL 'datalogger' names.  'datalogger' and 'preamplifier' names must be in instrumentation_components",
                            "required": ["datalogger"],
                            "properties": {
                                "datalogger": { "type": "string" },
                                "preamplifier": { "type": "string" }
                            }
                        }
                    }
                }
			}
		},
		"equipmentType": {
			"type": "object",
			"required": ["type", "description", "manufacturer", "vendor",
				"model", "serial_number", "calibration_date"
			],
			"properties": {
                "type": { "type": ["string","null"] },
                "description": { "type": ["string","null"] },
                "manufacturer": { "type": ["string","null"] },
                "vendor": { "type": ["string","null"] },
                "model": { "type": ["string","null"] },
                "serial_number": { "type": ["string","null"] },
                "calibration_date": {
                    "type": ["string","null"],
                    "description": "Date of calibration used in response file",
                    "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$",
                    "format": "date-time"
                }
			}
		},
		"equipmentType_noRequired": {
			"type": "object",
			"properties": {
                "type": { "type": ["string","null"] },
                "description": { "type": ["string","null"] },
                "manufacturer": { "type": ["string","null"] },
                "vendor": { "type": ["string","null"] },
                "model": { "type": "string" },
                "serial_number": { "type": ["string","null"] },
                "calibration_date": {
                    "type": ["string","null"],
                    "description": "Date of calibration used in response file",
                    "pattern": "^([0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z)|([0-9]{4})$"
                }
			}
		},
		"phone": {
            "type": "string",
            "description": "...",
			"pattern": "^[0-9]+-[0-9]+$"
		},
        "date": {
            "type": "string",
            "description": "Date in yyyy-mm-dd format",
			"pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
        },
        "author" : {
			"type": "object",
			"required": ["first_name","last_name"],
            "properties": {
                "first_name": { "type": "string" },
                "last_name": { "type": "string" },
                "email": { "type": "string" },
                "institution": { "type": "string" },
                "telephone": { "type": ["string","null"] }
            }
        }
	}
}

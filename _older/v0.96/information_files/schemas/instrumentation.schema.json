{
	"$schema": "http://json-schema.org/draft-06/schema#",
	"title": "Instrumentation",
	"description": "OBS facility instruments and their components",
	"type": "object",
	"required": [ "instrumentation" ],
	"properties": {
		"instrumentation": {
			"type": "object",
			"required": [
                "format_version",
				"revision",
				"facility",
				"components_file",
				"variables",
				"azi_dip",
				"instruments"
			],
			"properties": {
                "format_version": {
                    "description": "Version of this file's schema",
                    "type": "string",
                    "minLength": 3,
                    "pattern": "^0\\.96$"
                },
				"revision": {
					"type": "object",
					"description": "Date provenance of instrumentation information",
					"required": ["date"],
					"properties": {
					    "date": { "$ref": "#/definitions/date" },
					    "author": {"$ref": "#/definitions/author"}
					}
				},
				"facility": {
					"type": "object",
					"description": "OBS facility information",
					"required": ["reference_name", "full_name", "email", "website"],
					"properties": {
						"reference_name": {
							"type": "string",
							"description": "YAML filename should be '{reference_name}.instrumentation.yaml'"
						},
						"full_name": {
							"type": "string"
						},
						"email": {
							"type": "string",
							"format": "email"
						},
						"website": {
							"type": "string",
							"format": "uri"
						},
						"phone_number": {
							"type": "string"
						}
					}
				},
				"components_file": {
					"type": "string",
					"description": "file containing instrumentation components"
				},
				"variables": {
					"type": "array",
					"minItems": 0,
					"items": {
						"type": "string",
						"minLength": 1
					},
					"uniqueItems": true,
					"description": "Variables that must be specified in the Network file. The station creator will look for this key at the station level and stuff it's value into any text within the instrument that has the same key between curly brackets (for example, '*{sample_rate}*')"
				},
                "azi_dip": {
                    "type": "object",
                    "description": "Configurations for sensor azimuth and dip",
                    "properties": {
                        "azimuth": {"type": "string"},
                        "dip": {"type": "string"}
                    }
                },
				"instruments": {
					"type": "object",
					"description": "Instrument reference codes",
					"required": ["generic"],
					"properties": {
					    "generic" : {
					        "description" : "Generic descriptions of instruments",
                            "type": "object",
                            "minProperties": 1,
                            "patternProperties": {
                                "^[A-Za-z0-9_-]+$": {
                                    "type": "object",
                                    "description": "Individual instrument descriptions",
                                    "required": [
                                        "equipment",
                                        "channels"
                                    ],
                                    "properties": {
                                        "equipment": {"$ref": "#/definitions/equipmentType"},
                                        "channels": {
                                            "type": "object",
                                            "description": "A dictionary of channel:locations",
                                            "patternProperties": {
                                                "^[A-Za-z]{3}:[0-9]{2}$": {
                                                    "type": "object",
                                                    "description": "Each string must correspond to a component reference_code in the instrumentation_components file",
                                                    "required": [
                                                        "datalogger",
                                                        "preamplifier",
                                                        "sensor",
                                                        "azi_dip"
                                                    ],
                                                    "properties": {
                                                        "datalogger": {
                                                            "type": "object",
                                                            "required": ["reference_code"],
                                                            "properties" : { 
                                                                "reference_code" : {"type" : "string"}
                                                            }
                                                        },
                                                        "ana_filter": {
                                                            "type": "object",
                                                            "required": ["reference_code"],
                                                            "properties" : { 
                                                                "reference_code" : {"type" : "string"}
                                                            }
                                                        },
                                                        "sensor": {
                                                            "type": "object",
                                                            "required": ["reference_code"],
                                                            "properties" : { 
                                                                "reference_code" : {"type" : "string"}
                                                            }
                                                        },
                                                        "azi_dip": {
                                                            "type": "object",
                                                            "required": ["reference_code"],
                                                            "properties" : { 
                                                                "reference_code" : {"type" : "string"}
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        },
					    "specific" : {
					        "description" : "Specific descriptions of instruments",
                            "type": "object",
                            "minProperties": 1,
                            "patternProperties": {
                                "^[A-Za-z0-9_-]+$": {
                                    "type": "object",
                                    "description": "Specific instrument descriptions",
                                    "properties": {
                                        "equipment": {"$ref": "#/definitions/equipmentType_noRequired"},
                                        "channels": {
                                            "type": "object",
                                            "description": "A dictionary of channel:locations",
                                            "patternProperties": {
                                                "^[A-Za-z]{3}:[0-9]{2}$": {
                                                    "type": "object",
                                                    "description": "Each string must correspond to a component reference_code in the instrumentation_components file",
                                                    "properties": {
                                                        "datalogger": {
                                                            "anyOf": [
                                                                {"$ref": "#/definitions/equipmentType_noRequired"},
                                                                { "properties" : { "reference_code" : {"type" : "string"}}}
                                                            ]
                                                        },
                                                        "ana_filter": {
                                                            "anyOf": [
                                                                {"$ref": "#/definitions/equipmentType_noRequired"},
                                                                { "properties" : { "reference_code" : {"type" : "string"}}}
                                                            ]
                                                        },
                                                        "sensor": {
                                                            "anyOf": [
                                                                {"$ref": "#/definitions/equipmentType_noRequired"},
                                                                { "properties" : { "reference_code" : {"type" : "string"}}}
                                                            ]
                                                        },
                                                        "azi_dip": {
                                                            "description" : "azimuth and dip for the sensor",
                                                            "type": "string"
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            },
					        "additionalProperties": false
                        }
                    }
				}
			}
		},
		"loggers_NRL": {
			"type": "object",
			"description": "Convenience definitions for creating Nominal Reference Library (not yet implemented)",
			"patternProperties": {
				"^[A-Za-z0-9_-]+$": {
					"type": "object",
					"description": "keys are NRL 'datalogger' names.  'datalogger' and 'preamplifier' names must be in instrumentation_components",
					"required": ["datalogger"],
					"properties": {
						"datalogger": {
							"type": "string"
						},
						"preamplifier": {
							"type": "string"
						}
					}
				}
			}
		}
	},
	"definitions": {
		"equipmentType": {
			"type": "object",
			"required": ["type", "description", "manufacturer", "vendor",
				"model", "serial_number", "calibration_date"
			],
			"properties": {
                "type": { "type": ["string","null"] },
                "description": { "type": ["string","null"] },
                "manufacturer": { "type": ["string","null"] },
                "vendor": { "type": ["string","null"] },
                "model": { "type": ["string","null"] },
                "serial_number": { "type": ["string","null"] },
                "calibration_date": {
                    "type": ["string","null"],
                    "description": "Date of calibration used in response file",
                    "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$",
                    "format": "date-time"
                }
			}
		},
		"equipmentType_noRequired": {
			"type": "object",
			"properties": {
                "type": { "type": ["string","null"] },
                "description": { "type": ["string","null"] },
                "manufacturer": { "type": ["string","null"] },
                "vendor": { "type": ["string","null"] },
                "model": { "type": "string" },
                "serial_number": { "type": ["string","null"] },
                "calibration_date": {
                    "type": ["string","null"],
                    "description": "Date of calibration used in response file",
                    "pattern": "^([0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z)|([0-9]{4})$"
                }
			}
		},
		"phone": {
            "type": "string",
            "description": "...",
			"pattern": "^[0-9]+-[0-9]+$"
		},
        "date": {
            "type": "string",
            "description": "Date in yyyy-mm-dd format",
			"pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
        },
        "author" : {
			"type": "object",
			"required": ["first_name","last_name"],
            "properties": {
                "first_name": { "type": "string" },
                "last_name": { "type": "string" },
                "email": { "type": "string" },
                "institution": { "type": "string" },
                "telephone": { "type": ["string","null"] }
            }
        }
	}
}
